groups:
  - name: api_performance
    rules:
      # Recording rules
      - record: api:http_request_rate
        expr: rate(http_requests_total[1m])
        labels:
          description: "HTTP request rate per minute"
          
      - record: api:http_error_rate
        expr: rate(http_requests_total{code=~"5.."}[5m]) / rate(http_requests_total[5m])
        labels:
          description: "HTTP 5xx error rate"
          
      - record: api:response_time_p95
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))
        labels:
          description: "API response time 95th percentile"

  - name: api_alerts
    rules:
      # Alerting rules
      - alert: HighErrorRate
        expr: api:http_error_rate > 0.05
        for: 2m
        labels:
          severity: warning
          service: content-api
        annotations:
          summary: "High error rate detected"
          description: "API error rate is {{ $value | humanizePercentage }} for more than 2 minutes"
          
      - alert: HighResponseTime
        expr: api:response_time_p95 > 2
        for: 5m
        labels:
          severity: warning
          service: content-api
        annotations:
          summary: "High response time detected"
          description: "API p95 response time is {{ $value }}s for more than 5 minutes"
          
      - alert: APIDown
        expr: up{job="content-api"} == 0
        for: 1m
        labels:
          severity: critical
          service: content-api
        annotations:
          summary: "API service is down"
          description: "API service has been down for more than 1 minute"

  - name: worker_alerts
    rules:
      # Recording rules
      - record: worker:task_failure_rate
        expr: rate(celery_tasks_failed_total[5m]) / rate(celery_tasks_total[5m])
        labels:
          description: "Worker task failure rate"
          
      # Alerting rules  
      - alert: HighTaskFailureRate
        expr: worker:task_failure_rate > 0.1
        for: 3m
        labels:
          severity: warning
          service: workers
        annotations:
          summary: "High worker task failure rate"
          description: "Worker task failure rate is {{ $value | humanizePercentage }} for more than 3 minutes"
          
      - alert: LowCacheHitRate
        expr: cache_hits_total / (cache_hits_total + cache_misses_total) < 0.8
        for: 5m
        labels:
          severity: warning
          service: cache
        annotations:
          summary: "Low cache hit rate"
          description: "Cache hit rate is {{ $value | humanizePercentage }} for more than 5 minutes"